@page "/vdr"
@using Company_Site.Data;
@using Company_Site.Enum;
@using Company_Site.Pages.Components
@using Radzen.Blazor
@using Radzen;

<p class="fw-bold text-button-heading mb-2">VDR</p>

<Modal Title="File Upload" ShowModal=ShowUploadFileModal>
    <EditForm Model="NewItem" OnValidSubmit="SubmitFiles">
        <div>
            <div>
                <MultiErrorView Errors="_errors"/>
            </div>
            <div class="d-flex align-items-center">
                <p class="mx-1 mb-0">Upload Files</p>
                <p class="mb-0 mx-1"><strong>@Files.Count</strong> File(s) Selected</p>
            </div>
            <div @ondragover:preventDefault=true
                 @ondragover=DraggedOverDropPoint>
                <a class="d-flex align-items-center justify-content-center file-upload-box" 
                @onclick=UploadFiles>
                    <i class="fa fa-upload mx-1"></i>
                    <p class="mb-0">Upload</p>
                </a>
                <div class="@(ShowInputField ? "" : "d-none")">
                    <InputFile id="fileInput" OnChange="FileChanged" @bind-Value="Files" class="form-control file-upload-box" multiple type="file" />
                </div>
            </div>
            <div class="files-container">
                @foreach(IBrowserFile file in Files)
                {
                    <div class="file-item">
                        <p class="mb-0">@file.Name</p>
                        <a @onclick="@(() => RemoveFile(file))">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                }
            </div>
            @if (isUploading)
            {
                <div class="progress-bar-container my-3">
                    <div class="progress-bar" style="width: @_progress%"/>
                </div>
            }
            <div class="d-flex my-3 justify-content-center">
                <input type="submit" value="Upload" class="btn btn-outline-primary mx-1" />
                <a class="btn btn-outline-danger mx-1" @onclick=HideUploadForm>Cancel</a>
            </div>
        </div>
    </EditForm>
</Modal>


<Modal Title="File Settings" ShowModal=SettingsFormShown Width="70" CustomWidth=true>
    <EditForm Model="NewAccessEntry" OnValidSubmit="SaveAccessEntry">
        <div class="d-flex my-1 align-items-center">
            <label class="mx-1 my-0">Contact</label>
            <RadzenDropDown class="ms-1 form-select" 
                AllowFiltering="true" 
                TValue="string" 
                Value=SelectedContactId 
                Data="Contacts" 
                TextProperty="FullName" 
                ValueProperty="ContactId"
                Change="ContactChanged"/>
        </div>
        <div class="row align-items-center my-1">
            <div class="col-6">
                <div class="d-flex my-1 align-items-center">
                    <label class="mx-1 my-0 no-wrap">Access End Date</label>
                    <input type="date" class="form-control" @bind-value=NewAccessEntry.EndDate/>
                </div>
            </div>
            <div class="col-6">
                <div class="d-flex my-1 align-items-center">
                    <label class="mx-1 my-0">Allow Download</label>
                    <InputCheckbox @bind-Value=NewAccessEntry.AllowDownload type="checkbox" />
                </div>
            </div>
        </div>
        <div class="d-flex my-1 align-items-center">
            <label class="mx-1 my-0 no-wrap">Add Water Mark</label>
            <RadzenDropDown Multiple="true" 
                Chips="true" 
                MaxSelectedLabels="3" 
                AllowClear="true" 
                AllowFiltering="true" 
                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" 
                Data=@WaterMarks
                @bind-Value=@SelectedWaterMarks
                TextProperty="Name" 
                ValueProperty="Id" 
                class="w-100"/>
        </div>
        <div class="row align-items-center mt-3 mb-2">
            <div class="col-4 d-flex align-items-center justify-content-center">
                <input type="submit" value="Save Settings" class="btn btn-primary"/>
            </div>
            <div class="col-4 d-flex align-items-center justify-content-center">
                <a class="btn btn-danger" @onclick=DeleteFile>Delete File</a>
            </div>
            <div class="col-4 d-flex align-items-center justify-content-center">
                <a class="btn btn-secondary" @onclick=@(() => SettingsFormShown = false)>Close</a>
            </div>
        </div>
        <div class="mt-3">
            <Table ShowSerialNumber=true 
                T="AccessEntry" 
                T2="int" 
                Headers="AccessTableHeaders" 
                Items="AccessEntries" 
                GetId="GetAccessId" 
                OnDelete="RemoveAccessEntry" 
                IsEditable="@(t => false)" 
                IsSearchable=false 
                ValueCallback="ValueCallback" /> 
        </div>
    </EditForm>
</Modal>

<Modal ShowModal=IsDeleteConfirmationVisible Title="Confirmation to delete record">
    <div class="my-2">
        <p>Are you sure you want to delete the record?</p>
    </div>
    <div class="d-flex justify-content-center my-2">
        <button type="button" class="btn btn-primary mx-1 w-50" @onclick=CancelDeleteConfirmation>Close</button>
        <button type="button" @onclick="DeleteRecord" class="btn btn-danger mx-1 w-50">Confirm</button>
    </div>
</Modal>

<Modal ShowModal=isFolderDialogShown Title="Folder Dialog">
    <EditForm Model="this">

        <MultiErrorView Errors="_folderErrors"/>

        <div class="d-flex my-1 align-items-center">
            <label class="mx-1 my-0 no-wrap">Folder Name</label>
            <InputText class="form-control" @bind-Value=folderName/>
        </div>

        <div class="d-flex mt-3 align-items-center justify-content-center">
            <a class="btn btn-outline-primary mx-1" @onclick=CreateFolder>
                Create
            </a>
            <a class="btn btn-outline-danger mx-1" @onclick=CancelFolderDialog>
                Cancel
            </a>
        </div>
    </EditForm>
</Modal>

<div class="card py-3 px-4">
    <div class="row align-items-center">
        <div class="col-6">
            @if(string.IsNullOrEmpty(_displayedPath))
            {
                <h5 class="mb-0">All Files</h5>
            }
            else
            {
                <div class="d-flex align-items-center">
                    <a class="btn btn-secondary mx-1" @onclick=NavigateFolderBack>
                        <i class="fa fa-arrow-left"></i>
                    </a>
                    <h5 class="mb-0 ms-3">\@_displayedPath</h5>
                </div>
            }
        </div>
        <div class="col-6 d-flex justify-content-end">
            <a class="btn btn-outline-primary mx-1" @onclick=ShowFolderDialog>
                Create Folder
            </a>
            <a class="btn btn-outline-primary mx-1" @onclick=ShowUploadForm>
                Upload File
            </a>
        </div>
    </div>
    <div class="mt-3">
        <table class="data-table">
            <tr>
                <th>
                    <div>
                        SR
                    </div>
                </th>
                <th>
                    <div>
                        Name
                    </div>
                </th>
                <th>
                    <div>
                        Type
                    </div>
                </th>
                <th>
                    <div>
                        Created On
                    </div>
                </th>
                <th>
                    <div>
                        Created By
                    </div>
                </th>
                <th>
                    <div>
                        Size
                    </div>
                </th>
                <th>
                    <div>
                        Manage
                    </div>
                </th>
            </tr>
            @{
                int index = 1;
                foreach(FileItem item in _fileItems)
                {
                    <tr class="file-row">
                        <td>
                            <div>
                                @index
                            </div>
                        </td>
                        <td>
                            @if(item.Type == FileType.File)
                            {
                                <div>
                                    <a class="mb-0 file-name" download="@item.FileName" href="@($"/{FOLDER_NAME}/{item.FileName}")">@item.FileName.Split("$$")[0]</a>
                                    <p class="mb-0 file-extension">@(new System.IO.FileInfo(item.FileName).Extension)</p>
                                </div>
                            }
                            else
                            {
                                <div>
                                    <a @onclick=@(() => FolderClicked(item.FileName)) class="mb-0 file-name">@item.FileName.Split("$$")[0]</a>
                                </div>
                            }
                        </td>
                        <td>
                            <div>
                                <p class="mb-0 file-name">@item.Type.ToString()</p>
                            </div>
                        </td>
                        <td>
                            <div>
                                @item.CreationDate.ToString("dd-MMM-yyyy")
                            </div>
                        </td>
                        <td>
                            <div>
                                Harshal Gandhi
                            </div>
                        </td>
                        <td>
                            @if(item.Type == FileType.File)
                            {
                                <div>
                                    @ToMb(item.File.Size)Mb
                                </div>
                            }
                            else
                            {
                                <div>
                                    ---
                                </div>
                            }
                        </td>
                        <td>
                            <div class="btn-row">
                                <a class="row-btn" @onclick=@(() => OpenSettings(item.Id))><i class="fa fa-ellipsis-v"></i></a>
                            </div>
                        </td>
                    </tr>
                    index++;
                }
            }
        </table>
    </div>
</div>

