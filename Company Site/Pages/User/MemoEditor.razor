@page "/memoeditor"
@using Company_Site.DB
@using Company_Site.Data
@using Company_Site.Enum
@using Company_Site.Helpers
@using Company_Site.Pages.Components
@using Company_Site.ViewModels
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.Extensions.Primitives
@inject ApplicationDbContext dbContext
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navManager

<PageTitle>Memo Editor</PageTitle>

<AuthorizeView Roles="Admin">

	<Authorized >

		<div class="px-lg-5">
			<EditForm Model="NewMemo" Context="childContext" OnValidSubmit="AddMemo">

				<DataAnnotationsValidator/>
				<ValidationSummary/>
				<ErrorView Error="@Error"/>


				<h4>Memo Information</h4>

				<fieldset>

					<legend>Personal Information</legend>

					<div class="row">
						<div class="col-6">
							<div class="form-floating mb-3 mx-1">
								<InputText type="text" class="form-control" id="department" placeholder="Department" Value="@NewMemo.Department" ValueChanged="DepartmentChanged" ValueExpression="() => NewMemo.Department"/>
								<label for="department">Department</label>
							</div>
						</div>
						<div class="col-6">
							<div class="form-floating mb-3 mx-1">
							  <InputText type="text" class="form-control" id="memono" placeholder="Meemo No" @bind-Value="NewMemo.MemoNumber"/>
							  <label for="memono">Memo No</label>
							</div>

						</div>
						<div class="col-6">
							<div class="form-floating mb-3 mx-1">
							  <InputText type="text" class="form-control" id="branch" placeholder="Branch" @bind-Value="NewMemo.Branch"/>
							  <label for="branch">Branch</label>
							</div>
						</div>
						<div class="col-6">
							<div class="form-floating mb-3 mx-1">
							  <InputDate class="form-control" id="date" placeholder="Date" Value="@NewMemo.Date" ValueChanged="((Action<DateTime>)DateChanged)" ValueExpression="() => NewMemo.Date"/>
							  <label for="date">Date</label>
							</div>
						</div>
					</div>

				</fieldset>

				<fieldset class="my-2">

					<legend>Memo Financial</legend>

					<div class="row">
						<div class="col-6">

							<div class="form-floating mb-3 mx-1">
							  <input type="number" min="0" class="form-control" disabled="@(!NewMemo.Financial)" id="memoamount" placeholder="Total Memo Amount" @bind-value="@NewMemo.Amount"/>
							  <label for="memoamount">Total Memo Amount</label>
							</div>
						</div>
						<div class="col-6">
							<div class="input-group mb-3 d-flex align-items-center">
								<label for="periodicity" class="me-1">Periodicity</label>
								<InputSelect @bind-Value="NewMemo.Periodicity"  id="periodicity" class="form-select">
									<option selected>--- Select Periodicity ---</option>
									<option>Daily</option>
									<option>Weekly</option>
									<option>Monthly</option>
								</InputSelect>
							</div>

						</div>
						<div class="col-6">
							<div class="form-floating mb-3 mx-1">
							  <input type="date" class="form-control" id="validTill" placeholder="Valid Till" @bind-value="NewMemo.ValidTill"/>
							  <label for="validTill">Valid Till</label>
							</div>
						</div>

						<div class="col-6">
							<div class="form-floating mb-3 mx-1">
							  <InputText type="text" class="form-control" id="casename" placeholder="Case Name" @bind-Value="NewMemo.CaseName"/>
							  <label for="casename">Case Name</label>
							</div>
						</div>
					</div>

				</fieldset>

				<fieldset>

					<div class="row">
						<div class="col-6">

							<div class="input-group mb-3 mx-1 d-flex align-items-center">
							  <label for="memoamount" class="me-1">Financial</label>
							  <InputCheckbox  id="financial" class="form-check" @bind-Value="@NewMemo.Financial"/>
							</div>
						</div>
						<div class="col-6">
							<div class="input-group mb-3 d-flex align-items-center">
								<label for="type" class="me-1">Type</label>
								<InputSelect @bind-Value="NewMemo.Type"  id="type" class="form-select">
									<option selected>--- Select Type ---</option>
									<option>Bill</option>
									<option>Note</option>
									<option>Update</option>
									<option>Empanelment</option>
								</InputSelect>
							</div>
						</div>
						<div class="col-6">
							<div class="input-group mb-3 d-flex align-items-center">
								<label for="frequency" class="me-1">Frequency</label>
								<InputSelect @bind-Value="NewMemo.Frequency" disabled="@(!NewMemo.Financial)" id="frequency" class="form-select">
									<option selected>--- Select Frequency ---</option>
									<option>OneTime</option>
									<option>Monthly</option>
									<option>Quaterly</option>
									<option>Anually</option>
								</InputSelect>
							</div>
						</div>
					</div>

				</fieldset>

				<fieldset>

					<legend>Approval Authority</legend>

					<div class="row">
						<div class="col-12">
							<div class="row mb-3 d-flex align-items-center">
								<div class="col-2">
									<label class="me-1">Memo To:</label>
								</div>
								<div class="col">
									<MultiSelect Options="@Users" @bind-SelectedOptions="NewMemo.To"/>
								</div>
							</div>
						</div>
						<div class="col-12">
							<div class="input-group mb-3 d-flex align-items-center">
								<div class="col-2">
									<label class="me-1">Memo Through:</label>
								</div>
								<div class="col">
									<MultiSelect Options="@Users" @bind-SelectedOptions="NewMemo.Through"/>
								</div>
							</div>
						</div>
						<div class="col-12">
							<div class="row mb-3">
								<div class="col-2">
									<label class="me-1">Memo From:</label>
								</div>
								<div class="col">
									<MultiSelect Options="@Users" @bind-SelectedOptions="NewMemo.From"/>
								</div>
							</div>
						</div>
					</div>
				</fieldset>

				<fieldset>

					<legend>Subject</legend>

					<div class="row">
						<div class="col-12">

							<div class="form-floating mb-3 mx-1">
								<InputText type="text" class="form-control" id="subject" placeholder="Subject" @bind-Value="NewMemo.Subject"/>
								<label for="subject">Subject</label>
							</div>
						</div>
						<div class="col-6">
							<div class="input-group mb-3 d-flex align-items-center">
								<label for="vendor" class="me-1">Vendor</label>
								<InputSelect @bind-Value="NewMemo.Vendor"  id="vendor" class="form-select">
									<option selected>--- Select Vendor ---</option>
									<option>Haier Store</option>
								</InputSelect>
							</div>
						</div>
					</div>

				</fieldset>

				<fieldset>

					<legend>Memo Description or Attach Word File</legend>

					<div class="row">
						<div class="col-12">
							
						</div>
						<div class="col-12">
							<div class="input-group mb-3 d-flex align-items-center">
								<label for="files" class="me-1">Files</label>
								<InputFile id="files" @bind-Value="@NewMemo.Files" OnChange="FilesChanged" multiple/>
							</div>
							<div class="row px-2">
								@foreach(IBrowserFile file in NewMemo.Files){
									<div class="col-md-2 col-3 m-2 p-2 file-box">
										<div class="position-relative">
											<a class="rounded-pill cancel-btn" @onclick="@(() => RemoveFile(file))">X</a>
										</div>
										<div class="d-flex justify-content-center">
											@if(file.ContentType == "image/png" || file.ContentType == "image/jpg")
											{
												<img src="/img/img.png" class="w-75 h-75 mt-2"/>
											}
											else if(file.ContentType == "application/pdf")
											{
												<img src="/img/pdf.png" class="w-75 h-75 mt-2"/>
											}
											else
											{
												<img src="/img/word.png" class="w-75 h-75 mt-2"/>
											}
										</div>
										<p class="m-0 text-center">@file.Name</p>
									</div>
								}
							</div>
						</div>
					</div>

				</fieldset>

				<div class="input-group d-flex justify-content-end mb-3">
					@if(PageMode == PageMode.Add){
						<div>
							<a class="btn btn-outline-primary" @onclick="SaveDraft">Save as draft</a>
							<input type="submit" value="Send" class="btn btn-outline-success ms-1"/>
						</div>
					}
					else{
						<div>
							<a class="btn btn-outline-danger" @onclick="Discard">Discard</a>
							<a class="btn btn-outline-primary" @onclick="SaveDraft">Save as draft</a>
							<input type="submit" value="Send" class="btn btn-outline-success ms-1"/>
						</div>
					}
				</div>

			</EditForm>
		</div>

	</Authorized>

	<NotAuthorized>
		<LoginRedirect ReturnUrl="/memoeditor" />
	</NotAuthorized>

</AuthorizeView>

@code {

	//The error which is being displayed
	private string Error { get; set; }

	private MemoViewModel NewMemo { get; set; } = new MemoViewModel();

	private List<string> Users { get; set; } = new List<string>();

	private int MemoNumber = 1;

	private Company_Site.Data.User CurrentUser;

	public string id{ get; set; }

	private PageMode PageMode = PageMode.Add;

	private const long MAX_FILE_SIZE = 1024000 * 5;

	//Files change
	private void FilesChanged(InputFileChangeEventArgs e){
		if (e.GetMultipleFiles().Any(f => f.Size > MAX_FILE_SIZE))
			Error = "Files of max size 5MB are allowed";
		NewMemo.Files = e.GetMultipleFiles().ToList();
	}

	protected override async void OnInitialized()
	{
		base.OnInitialized();
		string[] param = navManager.Uri.Split("?");
		if(param.Count() > 1){
			Dictionary<string, StringValues> parameters = QueryHelpers.ParseQuery(param[1]);
			StringValues idValue;
			bool res = parameters.TryGetValue("id", out idValue);
			if (res)
				id = idValue;
		}

		if (id != null)
			PageMode = PageMode.Edit;

		Users = dbContext.Users.Select(u => $"{u.FirstName} {u.LastName}").ToList();

		if(PageMode == PageMode.Add){
			if (dbContext.Memos.Any())
				MemoNumber = int.Parse(dbContext.Memos.OrderBy(o => o.MemoNumber).Last().MemoNumber.Split('/').Last());
		}
		else{
			//Getting the Memo and Loading in the view model
			Memo memo = dbContext.Memos.Where(m => m.MemoNumber == id).First();
			NewMemo = new MemoViewModel()
				{
					Amount = memo.Amount,
					Branch = memo.Branch,
					CaseName = memo.CaseName,
					Date = memo.Date,
					Department = memo.Department,
					MemoNumber = memo.MemoNumber,
					Financial = memo.Financial,
					Frequency = memo.Frequency,
					IsDraft = memo.IsDraft,
					MemoStatus = memo.MemoStatus,
					Subject = memo.Subject,
					Vendor = memo.Vendor,
					ValidTill = memo.ValidTill,
					Text = memo.Text,
					Periodicity = memo.Periodicity,
					Type = memo.Type
				};
			List<int> fromIds = dbContext.MemoReferences.Where(m => m.Id == memo.FromId && m.MemoId == memo.MemoNumber).Select(m => m.UserId).ToList();
			List<int> throughIds = dbContext.MemoReferences.Where(m => m.Id == memo.ThroughId && m.MemoId == memo.MemoNumber).Select(m => m.UserId).ToList();
			List<int> toIds = dbContext.MemoReferences.Where(m => m.Id == memo.ToId && m.MemoId == memo.MemoNumber).Select(m => m.UserId).ToList();
			List<string> files = dbContext.Files.Where(m => m.MemoId == NewMemo.MemoNumber).Select(f => f.Path).ToList();


			NewMemo.From.AddRange(dbContext.Users.Where(func => fromIds.Contains(func.Id)).Select(user => $"{user.FirstName} {user.LastName}").ToList());
			NewMemo.Through.AddRange(dbContext.Users.Where(func => throughIds.Contains(func.Id)).Select(user => $"{user.FirstName} {user.LastName}").ToList());
			NewMemo.To.AddRange(dbContext.Users.Where(func => toIds.Contains(func.Id)).Select(user => $"{user.FirstName} {user.LastName}").ToList());
			NewMemo.Files = GetFiles(files);
		}

		AuthenticationState state = await authStateProvider.GetAuthenticationStateAsync();

		if(state.User.Identity.IsAuthenticated){
			CurrentUser = dbContext.Users.Where(user => user.UserName == state.User.Identity.Name).First();
		}

		StateHasChanged();
	}

	//Updates the memo number
	private void UpdateMemoNumber(){
		NewMemo.MemoNumber = "";
		if (!string.IsNullOrEmpty(NewMemo.Department))
			NewMemo.MemoNumber = $"{NewMemo.Department}";
		if (!string.IsNullOrEmpty(CurrentUser.FirstName))
			NewMemo.MemoNumber += $"/{CurrentUser.FirstName}";
		if (!string.IsNullOrEmpty(CurrentUser.LastName))
			NewMemo.MemoNumber += $"{CurrentUser.LastName.First()}";
		NewMemo.MemoNumber += $"/{NewMemo.Date.ToString("yy")}/{MemoNumber}";
	}

	private void DepartmentChanged(string department){
		NewMemo.Department = department;
		UpdateMemoNumber();
	}

	private void DateChanged(DateTime date){
		NewMemo.Date = date;
		UpdateMemoNumber();
	}

	private async void SaveDraft(){
		Memo memo = new Memo()
		{
			Amount = NewMemo.Amount,
			Branch = NewMemo.Branch,
			CaseName = NewMemo.CaseName,
			Date = NewMemo.Date,
			Department = NewMemo.Department,
			Financial = NewMemo.Financial,
			Frequency = NewMemo.Frequency,
			IsDraft = true,
			MemoNumber = NewMemo.MemoNumber,
			MemoStatus = Company_Site.Enum.MemoStatus.Pending,
			Periodicity = NewMemo.Periodicity,
			Subject = NewMemo.Subject,
			Text = NewMemo.Text,
			Type = NewMemo.Type,
			Vendor = NewMemo.Vendor,
			ValidTill = NewMemo.ValidTill,
		};

		dbContext.MemoReferences.RemoveRange(dbContext.MemoReferences.Where(f => f.MemoId == this.id));
		dbContext.Files.RemoveRange(dbContext.Files.Where(f => f.MemoId == this.id));

		int id = 1;
		if(dbContext.MemoReferences.Any())
			id = dbContext.MemoReferences.OrderBy(o => o.MemoId).Last().Id + 1;

		foreach(string user in NewMemo.From){
			int userId = dbContext.Users.AsEnumerable().Where(u => $"{u.FirstName} {u.LastName}" == user).First().Id;
			dbContext.MemoReferences.Add(new UserMemoReference() { Id = id, MemoId = NewMemo.MemoNumber, UserId = userId, MemoStatus = MemoStatus.Pending });
		}
		memo.FromId = id;
		id++;
		foreach (string user in NewMemo.Through)
		{
			int userId = dbContext.Users.AsEnumerable().Where(u => $"{u.FirstName} {u.LastName}" == user).First().Id;
			dbContext.MemoReferences.Add(new UserMemoReference() { Id = id, MemoId = NewMemo.MemoNumber, UserId = userId, MemoStatus = MemoStatus.Pending });
		}
		memo.ThroughId = id;
		id++;
		foreach (string user in NewMemo.To)
		{
			int userId = dbContext.Users.AsEnumerable().Where(u => $"{u.FirstName} {u.LastName}" == user).First().Id;
			dbContext.MemoReferences.Add(new UserMemoReference() { Id = id, MemoId = NewMemo.MemoNumber, UserId = userId, MemoStatus = MemoStatus.Pending });
		}
		memo.ToId = id;
		List<string> files = await SaveFiles(NewMemo.Files);
		int fileId = 1;
		if (dbContext.Files.Any())
			fileId = dbContext.Files.OrderBy(f => f.FileId).Last().FileId + 1;
		dbContext.Files.AddRange(files.Select(f => new File() { FileId = fileId++, Path = f, MemoId = memo.MemoNumber}));

		if(PageMode == PageMode.Add){
			if(dbContext.Memos.Where(f => f.MemoNumber == NewMemo.MemoNumber).Count() != 0)
			{
				Error = "Memo with the number already exists";
				return;
			}
			dbContext.Memos.Add(memo);
		}
		else
		{
			if (dbContext.Memos.Where(f => f.MemoNumber == NewMemo.MemoNumber).Count() != 0)
			{
				Memo foundMemo = dbContext.Memos.Where(m => m.MemoNumber == this.id).First();
				foundMemo.FromMemoViewModel(NewMemo);
			}
			else{
				dbContext.Memos.Remove(dbContext.Memos.Where(f => f.MemoNumber == this.id).First());
				dbContext.Memos.Add(memo);
			}
		}
		dbContext.SaveChanges();
		navManager.NavigateTo("/memomaster");
	}

	private async void AddMemo(){
		Memo memo = new Memo()
			{
				Amount = NewMemo.Amount,
				Branch = NewMemo.Branch,
				CaseName = NewMemo.CaseName,
				Date = NewMemo.Date,
				Department = NewMemo.Department,
				Financial = NewMemo.Financial,
				Frequency = NewMemo.Frequency,
				IsDraft = false,
				MemoNumber = NewMemo.MemoNumber,
				MemoStatus = Company_Site.Enum.MemoStatus.Pending,
				Periodicity = NewMemo.Periodicity,
				Subject = NewMemo.Subject,
				Text = NewMemo.Text,
				Type = NewMemo.Type,
				Vendor = NewMemo.Vendor,
				ValidTill = NewMemo.ValidTill,
			};

		dbContext.MemoReferences.RemoveRange(dbContext.MemoReferences.Where(f => f.MemoId == this.id));
		dbContext.Files.RemoveRange(dbContext.Files.Where(f => f.MemoId == this.id));

		int id = 1;
		if(dbContext.MemoReferences.Any())
			id = dbContext.MemoReferences.OrderBy(o => o.MemoId).Last().Id;

		foreach(string user in NewMemo.From){
			int userId = dbContext.Users.AsEnumerable().Where(u => $"{u.FirstName} {u.LastName}" == user).First().Id;
			dbContext.MemoReferences.Add(new UserMemoReference() { Id = id, MemoId = NewMemo.MemoNumber, UserId = userId, MemoStatus = MemoStatus.Pending });
		}
		memo.FromId = id;
		id++;
		foreach (string user in NewMemo.Through)
		{
			int userId = dbContext.Users.AsEnumerable().Where(u => $"{u.FirstName} {u.LastName}" == user).First().Id;
			dbContext.MemoReferences.Add(new UserMemoReference() { Id = id, MemoId = NewMemo.MemoNumber, UserId = userId, MemoStatus = MemoStatus.Pending });
		}
		memo.ThroughId = id;
		id++;
		foreach (string user in NewMemo.To)
		{
			int userId = dbContext.Users.AsEnumerable().Where(u => $"{u.FirstName} {u.LastName}" == user).First().Id;
			dbContext.MemoReferences.Add(new UserMemoReference() { Id = id, MemoId = NewMemo.MemoNumber, UserId = userId, MemoStatus = MemoStatus.Pending });
		}
		memo.ToId = id;

		memo.ToId = id;
		List<string> files = await SaveFiles(NewMemo.Files);
		int fileId = 1;
		if (dbContext.Files.Any())
			fileId = dbContext.Files.OrderBy(f => f.FileId).Last().FileId + 1;
		dbContext.Files.AddRange(files.Select(f => new File() { FileId = fileId++, Path = f, MemoId = this.id }));

		if (PageMode == PageMode.Add)
		{
			if (dbContext.Memos.Where(f => f.MemoNumber == NewMemo.MemoNumber).Count() != 0)
			{
				Error = "Memo with the number already exists";
				return;
			}
			dbContext.Memos.Add(memo);
		}
		else
		{
			if (dbContext.Memos.Where(f => f.MemoNumber == NewMemo.MemoNumber).Count() != 0)
			{
				Memo foundMemo = dbContext.Memos.Where(m => m.MemoNumber == this.id).First();
				foundMemo.FromMemoViewModel(NewMemo);
				foundMemo.IsDraft = false;
			}
			else
			{
				dbContext.Memos.Remove(dbContext.Memos.Where(f => f.MemoNumber == this.id).First());
				dbContext.Memos.Add(memo);
			}
		}
		dbContext.SaveChanges();
		navManager.NavigateTo("/memomaster");
	}

	private void Discard(){
		Memo m = dbContext.Memos.Where(m => m.MemoNumber == id).First();
		dbContext.MemoReferences.RemoveRange(dbContext.MemoReferences.Where(func => func.MemoId == m.MemoNumber));
		dbContext.Memos.Remove(m);
		dbContext.SaveChanges();
		navManager.NavigateTo("/memomaster");
	}

	//Uploads and saves files
	private async Task<List<string>> SaveFiles(List<IBrowserFile> files){
		List<string> filePaths = new List<string>();
		foreach(IBrowserFile file in files){
			Stream stream = file.OpenReadStream(maxAllowedSize: MAX_FILE_SIZE);
			string filePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "files", file.Name);
			filePaths.Add(filePath);
			using(FileStream fileStream = new FileStream(filePath, FileMode.Create)){
				byte[] data = new byte[stream.Length];
				await stream.ReadAsync(data, 0, data.Length);
				await fileStream.WriteAsync(data, 0, data.Length);
			}
		}
		return filePaths;
	}

	private List<IBrowserFile> GetFiles(List<string> files){
		List<IBrowserFile> loadedFiles = new List<IBrowserFile>();
		foreach(string file in files){
			IBrowserFile f = new UploadedFile(file);
			loadedFiles.Add(f);
		}
		return loadedFiles; 
	}

	private void RemoveFile(IBrowserFile file){
		NewMemo.Files.Remove(file);
	}
}
